"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Effects = undefined;

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _task2 = require("./task");

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var raise = function raise(error) {
  throw Error("Effects should be created from task that never fail but it did fail with error " + error);
};

var ignore = function ignore(_) {
  return void 0;
};

var nil = _task2.Task.succeed(void 0);

var never = new _task2.Task(function (succeed, fail) {
  return void 0;
});

var Effects = function () {
  _createClass(Effects, null, [{
    key: "task",
    value: function task(_task) {
      return new Effects(_task);
    }
  }, {
    key: "tick",
    value: function tick(tag) {
      return new Tick(tag);
    }
  }, {
    key: "receive",
    value: function receive(action) {
      var fx = new Effects(new _task2.Task(function (succeed, fail) {
        return void Promise.resolve(action).then(succeed, fail);
      }));
      return fx;
    }
  }, {
    key: "batch",
    value: function batch(effects) {
      return new Batch(effects);
    }
  }, {
    key: "driver",
    value: function driver(address) {
      return function (fx) {
        if (!(fx instanceof None)) {
          _task2.Task.fork(fx.send(address), ignore, raise);
        }
      };
    }
  }]);

  function Effects(task) {
    _classCallCheck(this, Effects);

    this.task = task;
  }

  _createClass(Effects, [{
    key: "map",
    value: function map(f) {
      return new Effects(this.task.map(f));
    }
  }, {
    key: "send",
    value: function send(address) {
      return this.task.chain(function (value) {
        return _task2.Task.send(address, value);
      });
    }
  }]);

  return Effects;
}();

exports.Effects = Effects;

var None = function (_Effects) {
  _inherits(None, _Effects);

  function None() {
    _classCallCheck(this, None);

    return _possibleConstructorReturn(this, Object.getPrototypeOf(None).call(this, never));
  }

  _createClass(None, [{
    key: "map",
    value: function map(f) {
      return Effects.none;
    }
  }, {
    key: "send",
    value: function send(address) {
      return nil;
    }
  }]);

  return None;
}(Effects);

Effects.none = new None();

var Batch = function (_Effects2) {
  _inherits(Batch, _Effects2);

  function Batch(effects) {
    _classCallCheck(this, Batch);

    var _this2 = _possibleConstructorReturn(this, Object.getPrototypeOf(Batch).call(this, never));

    _this2.effects = effects;
    return _this2;
  }

  _createClass(Batch, [{
    key: "map",
    value: function map(f) {
      return new Batch(this.effects.map(function (effect) {
        return effect.map(f);
      }));
    }
  }, {
    key: "send",
    value: function send(address) {
      var _this3 = this;

      return new _task2.Task(function (succeed, fail) {
        var effects = _this3.effects;

        var count = effects.length;
        var index = 0;
        while (index < count) {
          var effect = effects[index];
          if (!(effect instanceof None)) {
            _task2.Task.fork(effect.send(address), ignore, raise);
          }

          index = index + 1;
        }
        succeed(void 0);
      });
    }
  }]);

  return Batch;
}(Effects);

var Tick = function (_Effects3) {
  _inherits(Tick, _Effects3);

  function Tick(tag) {
    _classCallCheck(this, Tick);

    var _this4 = _possibleConstructorReturn(this, Object.getPrototypeOf(Tick).call(this, never));

    _this4.tag = tag;
    return _this4;
  }

  _createClass(Tick, [{
    key: "map",
    value: function map(f) {
      var _this5 = this;

      return new Tick(function (time) {
        return f(_this5.tag(time));
      });
    }
  }, {
    key: "send",
    value: function send(address) {
      var _this6 = this;

      var task = new _task2.Task(function (succeed, fail) {
        return animationScheduler.schedule(function (time) {
          return succeed(_this6.tag(time));
        });
      }).chain(function (action) {
        return _task2.Task.send(address, action);
      });
      return task;
    }
  }]);

  return Tick;
}(Effects);

var NO_REQUEST = 0;
var PENDING_REQUEST = 1;
var EXTRA_REQUEST = 2;

var AnimationScheduler = function () {
  function AnimationScheduler() {
    _classCallCheck(this, AnimationScheduler);

    this.state = NO_REQUEST;
    this.requests = [];
    this.execute = this.execute.bind(this);
  }

  _createClass(AnimationScheduler, [{
    key: "schedule",
    value: function schedule(request) {
      if (this.state === NO_REQUEST) {
        window.requestAnimationFrame(this.execute);
      }

      this.requests.push(request);
      this.state = PENDING_REQUEST;
    }
  }, {
    key: "execute",
    value: function execute(time) {
      switch (this.state) {
        case NO_REQUEST:
          throw Error("Unexpected frame request");
        case PENDING_REQUEST:
          window.requestAnimationFrame(this.execute);
          this.state = EXTRA_REQUEST;
          this.dispatch(this.requests.splice(0), 0, time);
          break;
        case EXTRA_REQUEST:
          this.state = NO_REQUEST;
          break;
      }
    }
  }, {
    key: "dispatch",
    value: function dispatch(requests, index, time) {
      var count = requests.length;
      try {
        while (index < count) {
          var request = requests[index];
          index = index + 1;
          request(time);
        }
      } finally {
        if (index < count) {
          this.dispatch(requests, index, time);
        }
      }
    }
  }]);

  return AnimationScheduler;
}();

var animationScheduler = new AnimationScheduler();
//# sourceMappingURL=data:application/json;base64,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c2t9IGZyb20gXCIuL3Rhc2tcIlxuXG4vKjo6XG5pbXBvcnQgdHlwZSB7TmV2ZXJ9IGZyb20gXCIuL2VmZmVjdHNcIlxuaW1wb3J0IHR5cGUge0FkZHJlc3N9IGZyb20gXCIuL3NpZ25hbFwiXG4qL1xuXG5jb25zdCByYWlzZSA9XG4gIGVycm9yID0+IHtcbiAgICB0aHJvdyBFcnJvcihgRWZmZWN0cyBzaG91bGQgYmUgY3JlYXRlZCBmcm9tIHRhc2sgdGhhdCBuZXZlciBmYWlsIGJ1dCBpdCBkaWQgZmFpbCB3aXRoIGVycm9yICR7ZXJyb3J9YClcbiAgfVxuXG5jb25zdCBpZ25vcmUgPVxuICBfID0+XG4gIHZvaWQoMClcblxuY29uc3QgbmlsID1cbiAgVGFzay5zdWNjZWVkKHZvaWQoMCkpXG5cbmNvbnN0IG5ldmVyID1cbiAgbmV3IFRhc2soKHN1Y2NlZWQsIGZhaWwpID0+IHZvaWQoMCkpXG5cbmV4cG9ydCBjbGFzcyBFZmZlY3RzIC8qOjo8YT4qLyB7XG4gIHN0YXRpYyB0YXNrIC8qOjo8YT4qLyh0YXNrLyo6VGFzazxOZXZlciwgYT4qLykvKjpFZmZlY3RzPGE+Ki8ge1xuICAgIHJldHVybiBuZXcgRWZmZWN0cyh0YXNrKVxuICB9XG4gIHN0YXRpYyB0aWNrIC8qOjo8YT4qLyh0YWcvKjoodGltZTpUaW1lKSA9PiBhKi8pLyo6RWZmZWN0czxhPiovIHtcbiAgICByZXR1cm4gbmV3IFRpY2sodGFnKVxuICB9XG4gIHN0YXRpYyByZWNlaXZlIC8qOjo8YT4qLyhhY3Rpb24vKjphKi8pLyo6RWZmZWN0czxhPiovIHtcbiAgICBjb25zdCBmeCA9XG4gICAgICBuZXcgRWZmZWN0c1xuICAgICAgKCBuZXcgVGFza1xuICAgICAgICAoIChzdWNjZWVkLCBmYWlsKSA9PlxuICAgICAgICAgIHZvaWRcbiAgICAgICAgICAoIFByb21pc2VcbiAgICAgICAgICAgIC5yZXNvbHZlKGFjdGlvbilcbiAgICAgICAgICAgIC50aGVuKHN1Y2NlZWQsIGZhaWwpXG4gICAgICAgICAgKVxuICAgICAgICApXG4gICAgICApXG4gICAgcmV0dXJuIGZ4XG4gIH1cbiAgc3RhdGljIGJhdGNoIC8qOjo8YT4qLyhlZmZlY3RzLyo6QXJyYXk8RWZmZWN0czxhPj4qLykvKjpFZmZlY3RzPGE+Ki8ge1xuICAgIHJldHVybiBuZXcgQmF0Y2goZWZmZWN0cylcbiAgfVxuICBzdGF0aWMgZHJpdmVyIC8qOjo8YT4qLyhhZGRyZXNzLyo6QWRkcmVzczxhPiovKS8qOihmeDpFZmZlY3RzPGE+KSA9PiB2b2lkKi8ge1xuICAgIHJldHVybiBmeCA9PiB7XG4gICAgICBpZiAoIShmeCBpbnN0YW5jZW9mIE5vbmUpKSB7XG4gICAgICAgIFRhc2suZm9yayhmeC5zZW5kKGFkZHJlc3MpLCBpZ25vcmUsIHJhaXNlKVxuICAgICAgfVxuICAgIH1cbiAgfVxuICAvKjo6XG4gIHN0YXRpYyBub25lOkVmZmVjdHM8YW55PjtcbiAgdGFzazogVGFzazxOZXZlciwgYT47XG4gICovXG4gIGNvbnN0cnVjdG9yKHRhc2svKjpUYXNrPE5ldmVyLCBhPiovKSB7XG4gICAgdGhpcy50YXNrID0gdGFza1xuICB9XG4gIG1hcC8qOjo8Yj4qLyhmLyo6KGE6YSk9PmIqLykvKjpFZmZlY3RzPGI+Ki8ge1xuICAgIHJldHVybiBuZXcgRWZmZWN0cyh0aGlzLnRhc2subWFwKGYpKVxuICB9XG4gIHNlbmQoYWRkcmVzcy8qOkFkZHJlc3M8YT4qLykvKjpUYXNrPE5ldmVyLCB2b2lkPiovIHtcbiAgICByZXR1cm4gdGhpcy50YXNrLmNoYWluKHZhbHVlID0+IFRhc2suc2VuZChhZGRyZXNzLCB2YWx1ZSkpXG4gIH1cbn1cblxuY2xhc3MgTm9uZSAvKjo6PGE+Ki8gZXh0ZW5kcyBFZmZlY3RzIC8qOjo8YW55PiovIHtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgc3VwZXIobmV2ZXIpXG4gIH1cbiAgbWFwLyo6OjxiPiovKGYvKjooYTphKT0+YiovKS8qOkVmZmVjdHM8Yj4qLyB7XG4gICAgcmV0dXJuIEVmZmVjdHMubm9uZVxuICB9XG4gIHNlbmQoYWRkcmVzcy8qOkFkZHJlc3M8YT4qLykvKjpUYXNrPE5ldmVyLCB2b2lkPiovIHtcbiAgICByZXR1cm4gbmlsXG4gIH1cbn1cbkVmZmVjdHMubm9uZSA9IG5ldyBOb25lKClcblxuY2xhc3MgQmF0Y2ggLyo6OjxhPiovIGV4dGVuZHMgRWZmZWN0cyAvKjo6PGE+Ki8ge1xuICAvKjo6XG4gIGVmZmVjdHM6IEFycmF5PEVmZmVjdHM8YT4+O1xuICAqL1xuICBjb25zdHJ1Y3RvcihlZmZlY3RzLyo6QXJyYXk8RWZmZWN0czxhPj4qLykge1xuICAgIHN1cGVyKG5ldmVyKVxuICAgIHRoaXMuZWZmZWN0cyA9IGVmZmVjdHNcbiAgfVxuICBtYXAvKjo6PGI+Ki8oZi8qOihhOmEpPT5iKi8pLyo6RWZmZWN0czxiPiovIHtcbiAgICByZXR1cm4gbmV3IEJhdGNoKHRoaXMuZWZmZWN0cy5tYXAoZWZmZWN0ID0+IGVmZmVjdC5tYXAoZikpKVxuICB9XG4gIHNlbmQoYWRkcmVzcy8qOkFkZHJlc3M8YT4qLykvKjpUYXNrPE5ldmVyLCB2b2lkPiovIHtcbiAgICByZXR1cm4gbmV3IFRhc2soKHN1Y2NlZWQsIGZhaWwpID0+IHtcbiAgICAgIGNvbnN0IHtlZmZlY3RzfSA9IHRoaXNcbiAgICAgIGNvbnN0IGNvdW50ID0gZWZmZWN0cy5sZW5ndGhcbiAgICAgIGxldCBpbmRleCA9IDBcbiAgICAgIHdoaWxlIChpbmRleCA8IGNvdW50KSB7XG4gICAgICAgIGNvbnN0IGVmZmVjdCA9IGVmZmVjdHNbaW5kZXhdXG4gICAgICAgIGlmICghKGVmZmVjdCBpbnN0YW5jZW9mIE5vbmUpKSB7XG4gICAgICAgICAgVGFzay5mb3JrKGVmZmVjdC5zZW5kKGFkZHJlc3MpLCBpZ25vcmUsIHJhaXNlKVxuICAgICAgICB9XG5cbiAgICAgICAgaW5kZXggPSBpbmRleCArIDFcbiAgICAgIH1cbiAgICAgIHN1Y2NlZWQodm9pZCgwKSlcbiAgICB9KVxuICB9XG59XG5cblxuY2xhc3MgVGljayAvKjo6PGE+Ki8gZXh0ZW5kcyBFZmZlY3RzIC8qOjo8YT4qLyB7XG4gIC8qOjpcbiAgdGFnOiAodGltZTpUaW1lKSA9PiBhO1xuICAqL1xuICBjb25zdHJ1Y3Rvcih0YWcvKjoodGltZTpUaW1lKSA9PiBhKi8pIHtcbiAgICBzdXBlcihuZXZlcilcbiAgICB0aGlzLnRhZyA9IHRhZ1xuICB9XG4gIG1hcC8qOjo8Yj4qLyhmLyo6KGE6YSk9PmIqLykvKjpFZmZlY3RzPGI+Ki8ge1xuICAgIHJldHVybiBuZXcgVGljaygodGltZS8qOlRpbWUqLykgPT4gZih0aGlzLnRhZyh0aW1lKSkpXG4gIH1cbiAgc2VuZChhZGRyZXNzLyo6QWRkcmVzczxhPiovKS8qOlRhc2s8TmV2ZXIsIHZvaWQ+Ki8ge1xuICAgIGNvbnN0IHRhc2sgPVxuICAgICAgbmV3IFRhc2tcbiAgICAgICggKHN1Y2NlZWQsIGZhaWwpID0+XG4gICAgICAgIGFuaW1hdGlvblNjaGVkdWxlci5zY2hlZHVsZSh0aW1lID0+IHN1Y2NlZWQodGhpcy50YWcodGltZSkpKVxuICAgICAgKVxuICAgICAgLmNoYWluKGFjdGlvbiA9PiBUYXNrLnNlbmQoYWRkcmVzcywgYWN0aW9uKSlcbiAgICByZXR1cm4gdGFza1xuICB9XG59XG5cbi8vIEludmFyaWFudHM6XG4vLyAxLiBJbiB0aGUgTk9fUkVRVUVTVCBzdGF0ZSwgdGhlcmUgaXMgbmV2ZXIgYSBzY2hlZHVsZWQgYW5pbWF0aW9uIGZyYW1lLlxuLy8gMi4gSW4gdGhlIFBFTkRJTkdfUkVRVUVTVCBhbmQgRVhUUkFfUkVRVUVTVCBzdGF0ZXMsIHRoZXJlIGlzIGFsd2F5cyBleGFjdGx5XG4vLyBvbmUgc2NoZWR1bGVkIGFuaW1hdGlvbiBmcmFtZS5cbmNvbnN0IE5PX1JFUVVFU1QgPSAwXG5jb25zdCBQRU5ESU5HX1JFUVVFU1QgPSAxXG5jb25zdCBFWFRSQV9SRVFVRVNUID0gMlxuXG5cbi8qOjpcbnR5cGUgVGltZSA9IG51bWJlclxudHlwZSBTdGF0ZSA9IDAgfCAxIHwgMlxuKi9cblxuY2xhc3MgQW5pbWF0aW9uU2NoZWR1bGVyIHtcbiAgLyo6OlxuICBzdGF0ZTogU3RhdGU7XG4gIHJlcXVlc3RzOiBBcnJheTwodGltZTpUaW1lKSA9PiBhbnk+O1xuICBleGVjdXRlOiAodGltZTpUaW1lKSA9PiB2b2lkO1xuICAqL1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLnN0YXRlID0gTk9fUkVRVUVTVFxuICAgIHRoaXMucmVxdWVzdHMgPSBbXVxuICAgIHRoaXMuZXhlY3V0ZSA9IHRoaXMuZXhlY3V0ZS5iaW5kKHRoaXMpXG4gIH1cbiAgc2NoZWR1bGUocmVxdWVzdCkge1xuICAgIGlmICh0aGlzLnN0YXRlID09PSBOT19SRVFVRVNUKSB7XG4gICAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRoaXMuZXhlY3V0ZSlcbiAgICB9XG5cbiAgICB0aGlzLnJlcXVlc3RzLnB1c2gocmVxdWVzdClcbiAgICB0aGlzLnN0YXRlID0gUEVORElOR19SRVFVRVNUXG4gIH1cbiAgZXhlY3V0ZSh0aW1lLyo6VGltZSovKS8qOnZvaWQqLyB7XG4gICAgc3dpdGNoICh0aGlzLnN0YXRlKSB7XG4gICAgICBjYXNlIE5PX1JFUVVFU1Q6XG4gICAgICAgIC8vIFRoaXMgc3RhdGUgc2hvdWxkIG5vdCBiZSBwb3NzaWJsZS4gSG93IGNhbiB0aGVyZSBiZSBub1xuICAgICAgICAvLyByZXF1ZXN0LCB5ZXQgc29tZWhvdyB3ZSBhcmUgYWN0aXZlbHkgZnVsZmlsbGluZyBhXG4gICAgICAgIC8vIHJlcXVlc3Q/XG4gICAgICAgIHRocm93IEVycm9yKGBVbmV4cGVjdGVkIGZyYW1lIHJlcXVlc3RgKVxuICAgICAgY2FzZSBQRU5ESU5HX1JFUVVFU1Q6XG4gICAgICAgIC8vIEF0IHRoaXMgcG9pbnQsIHdlIGRvIG5vdCAqa25vdyogdGhhdCBhbm90aGVyIGZyYW1lIGlzXG4gICAgICAgIC8vIG5lZWRlZCwgYnV0IHdlIG1ha2UgYW4gZXh0cmEgZnJhbWUgcmVxdWVzdCBqdXN0IGluXG4gICAgICAgIC8vIGNhc2UuIEl0J3MgcG9zc2libGUgdG8gZHJvcCBhIGZyYW1lIGlmIGZyYW1lIGlzIHJlcXVlc3RlZFxuICAgICAgICAvLyB0b28gbGF0ZSwgc28gd2UganVzdCBkbyBpdCBwcmVlbXB0aXZlbHkuXG4gICAgICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5leGVjdXRlKVxuICAgICAgICB0aGlzLnN0YXRlID0gRVhUUkFfUkVRVUVTVFxuICAgICAgICB0aGlzLmRpc3BhdGNoKHRoaXMucmVxdWVzdHMuc3BsaWNlKDApLCAwLCB0aW1lKVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSBFWFRSQV9SRVFVRVNUOlxuICAgICAgICAvLyBUdXJucyBvdXQgdGhlIGV4dHJhIHJlcXVlc3Qgd2FzIG5vdCBuZWVkZWQsIHNvIHdlIHdpbGxcbiAgICAgICAgLy8gc3RvcCByZXF1ZXN0aW5nLiBObyByZWFzb24gdG8gY2FsbCBpdCBhbGwgdGhlIHRpbWUgaWZcbiAgICAgICAgLy8gbm8gb25lIG5lZWRzIGl0LlxuICAgICAgICB0aGlzLnN0YXRlID0gTk9fUkVRVUVTVFxuICAgICAgICBicmVha1xuICAgIH1cbiAgfVxuICBkaXNwYXRjaChyZXF1ZXN0cywgaW5kZXgsIHRpbWUpIHtcbiAgICBjb25zdCBjb3VudCA9IHJlcXVlc3RzLmxlbmd0aFxuICAgIHRyeSB7XG4gICAgICB3aGlsZSAoaW5kZXggPCBjb3VudCkge1xuICAgICAgICBjb25zdCByZXF1ZXN0ID0gcmVxdWVzdHNbaW5kZXhdXG4gICAgICAgIGluZGV4ID0gaW5kZXggKyAxXG4gICAgICAgIHJlcXVlc3QodGltZSlcbiAgICAgIH1cbiAgICB9IGZpbmFsbHkge1xuICAgICAgaWYgKGluZGV4IDwgY291bnQpIHtcbiAgICAgICAgdGhpcy5kaXNwYXRjaChyZXF1ZXN0cywgaW5kZXgsIHRpbWUpXG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmNvbnN0IGFuaW1hdGlvblNjaGVkdWxlciA9IG5ldyBBbmltYXRpb25TY2hlZHVsZXIoKVxuIl19