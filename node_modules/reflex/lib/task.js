'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol ? "symbol" : typeof obj; };

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Task = exports.Task = function () {
  _createClass(Task, null, [{
    key: 'create',
    value: function create(execute) {
      return new Task(execute);
    }
  }, {
    key: 'future',
    value: function future(request) {
      console.warn('Task.future is deprecated API use Task.create instead');
      return new Future(request);
    }
  }, {
    key: 'succeed',
    value: function succeed(value) {
      return new Succeed(value);
    }
  }, {
    key: 'fail',
    value: function fail(error) {
      return new Fail(error);
    }
  }, {
    key: 'spawn',
    value: function spawn(task) {
      return new Spawn(task);
    }
  }, {
    key: 'sleep',
    value: function sleep(time) {
      return new Sleep(time);
    }
  }, {
    key: 'send',
    value: function send(address, message) {
      return new Send(address, message);
    }
  }, {
    key: 'fork',
    value: function fork(task, onSucceed, onFail) {
      run(new Running(task), onSucceed, onFail);
    }
  }]);

  function Task(execute) {
    _classCallCheck(this, Task);

    this.execute = execute;
  }

  _createClass(Task, [{
    key: 'chain',
    value: function chain(next) {
      return new Chain(this, next);
    }
  }, {
    key: 'map',
    value: function map(f) {
      return new Map(this, f);
    }
  }, {
    key: 'capture',
    value: function capture(handle) {
      return new Capture(this, handle);
    }
  }, {
    key: 'format',
    value: function format(f) {
      return new Format(this, f);
    }
  }, {
    key: 'fork',
    value: function fork(succeed, fail) {
      this.execute(succeed, fail);
    }
  }]);

  return Task;
}();

var Succeed = function (_Task) {
  _inherits(Succeed, _Task);

  function Succeed(value) {
    _classCallCheck(this, Succeed);

    var _this = _possibleConstructorReturn(this, Object.getPrototypeOf(Succeed).call(this, Succeed.prototype.fork));

    _this.value = value;
    return _this;
  }

  _createClass(Succeed, [{
    key: 'fork',
    value: function fork(succeed, fail) {
      succeed(this.value);
    }
  }]);

  return Succeed;
}(Task);

var Fail = function (_Task2) {
  _inherits(Fail, _Task2);

  function Fail(error) {
    _classCallCheck(this, Fail);

    var _this2 = _possibleConstructorReturn(this, Object.getPrototypeOf(Fail).call(this, Fail.prototype.fork));

    _this2.error = error;
    return _this2;
  }

  _createClass(Fail, [{
    key: 'fork',
    value: function fork(succeed, fail) {
      fail(this.error);
    }
  }]);

  return Fail;
}(Task);

var Sleep = function (_Task3) {
  _inherits(Sleep, _Task3);

  function Sleep(time) {
    _classCallCheck(this, Sleep);

    var _this3 = _possibleConstructorReturn(this, Object.getPrototypeOf(Sleep).call(this, Sleep.prototype.fork));

    _this3.time = time;
    return _this3;
  }

  _createClass(Sleep, [{
    key: 'fork',
    value: function fork(succeed, fail) {
      setTimeout(succeed, this.time, void 0);
    }
  }]);

  return Sleep;
}(Task);

var threadID = 0;

var Spawn = function (_Task4) {
  _inherits(Spawn, _Task4);

  function Spawn(task) {
    _classCallCheck(this, Spawn);

    var _this4 = _possibleConstructorReturn(this, Object.getPrototypeOf(Spawn).call(this, Spawn.prototype.fork));

    _this4.task = task;
    return _this4;
  }

  _createClass(Spawn, [{
    key: 'fork',
    value: function fork(succeed, fail) {
      var _this5 = this;

      Promise.resolve(null).then(function (_) {
        return Task.fork(_this5.task, noop, noop);
      });

      succeed(++threadID);
    }
  }]);

  return Spawn;
}(Task);

var Send = function (_Task5) {
  _inherits(Send, _Task5);

  function Send(address, message) {
    _classCallCheck(this, Send);

    var _this6 = _possibleConstructorReturn(this, Object.getPrototypeOf(Send).call(this, Send.prototype.fork));

    _this6.message = message;
    _this6.address = address;
    return _this6;
  }

  _createClass(Send, [{
    key: 'fork',
    value: function fork(succeed, fail) {
      succeed(void this.address(this.message));
    }
  }]);

  return Send;
}(Task);

var Future = function (_Task6) {
  _inherits(Future, _Task6);

  function Future(request) {
    _classCallCheck(this, Future);

    var _this7 = _possibleConstructorReturn(this, Object.getPrototypeOf(Future).call(this, Future.prototype.fork));

    _this7.request = request;
    return _this7;
  }

  _createClass(Future, [{
    key: 'fork',
    value: function fork(succeed, fail) {
      this.request().then(succeed, fail);
    }
  }]);

  return Future;
}(Task);

var Chain = function (_Task7) {
  _inherits(Chain, _Task7);

  function Chain(task, next) {
    _classCallCheck(this, Chain);

    var _this8 = _possibleConstructorReturn(this, Object.getPrototypeOf(Chain).call(this, Chain.prototype.fork));

    _this8.task = task;
    _this8.next = next;
    return _this8;
  }

  _createClass(Chain, [{
    key: 'fork',
    value: function fork(succeed, fail) {
      var _this9 = this;

      this.task.fork(function (value) {
        return _this9.next(value).fork(succeed, fail);
      }, fail);
    }
  }]);

  return Chain;
}(Task);

var Map = function (_Task8) {
  _inherits(Map, _Task8);

  function Map(task, f) {
    _classCallCheck(this, Map);

    var _this10 = _possibleConstructorReturn(this, Object.getPrototypeOf(Map).call(this, Map.prototype.fork));

    _this10.task = task;
    _this10.f = f;
    return _this10;
  }

  _createClass(Map, [{
    key: 'fork',
    value: function fork(succeed, fail) {
      var _this11 = this;

      this.task.fork(function (value) {
        return succeed(_this11.f(value));
      }, fail);
    }
  }]);

  return Map;
}(Task);

var Capture = function (_Task9) {
  _inherits(Capture, _Task9);

  function Capture(task, handle) {
    _classCallCheck(this, Capture);

    var _this12 = _possibleConstructorReturn(this, Object.getPrototypeOf(Capture).call(this, Capture.prototype.fork));

    _this12.task = task;
    _this12.handle = handle;
    return _this12;
  }

  _createClass(Capture, [{
    key: 'fork',
    value: function fork(succeed, fail) {
      var _this13 = this;

      this.task.fork(succeed, function (error) {
        return _this13.handle(error).fork(succeed, fail);
      });
    }
  }]);

  return Capture;
}(Task);

var Format = function (_Task10) {
  _inherits(Format, _Task10);

  function Format(task, f) {
    _classCallCheck(this, Format);

    var _this14 = _possibleConstructorReturn(this, Object.getPrototypeOf(Format).call(this, Format.prototype.fork));

    _this14.task = task;
    _this14.f = f;
    return _this14;
  }

  _createClass(Format, [{
    key: 'fork',
    value: function fork(succeed, fail) {
      var _this15 = this;

      this.task.fork(succeed, function (error) {
        return fail(_this15.f(error));
      });
    }
  }]);

  return Format;
}(Task);

var Deferred = function (_Task11) {
  _inherits(Deferred, _Task11);

  function Deferred() {
    _classCallCheck(this, Deferred);

    return _possibleConstructorReturn(this, Object.getPrototypeOf(Deferred).call(this, Deferred.prototype.fork));
  }

  _createClass(Deferred, [{
    key: 'resume',
    value: function resume(task) {
      if (this.result != null) {
        throw Error('Deferred task can only be resumed once');
      }
      this.result = task;
    }
  }, {
    key: 'fork',
    value: function fork(succeed, fail) {
      throw Error('Forking defferred task is not allowed');
    }
  }]);

  return Deferred;
}(Task);

var noop = function noop() {
  return void 0;
};

var Running = function Running(task) {
  _classCallCheck(this, Running);

  this.task = task;
};

var Done = function Done(task) {
  _classCallCheck(this, Done);

  this.task = task;
};

var Blocked = function Blocked(task) {
  _classCallCheck(this, Blocked);

  this.task = task;
};

var run = function run(root, succeed, fail) {
  var routine = new Running(root.task);
  while (routine instanceof Running) {
    routine = step(root, routine.task, succeed, fail);
  }

  if (routine instanceof Blocked) {
    root.task = routine.task;
  }

  if (routine instanceof Done) {
    var task = routine.task;
    if (task instanceof Succeed) {
      succeed(task.value);
    } else if (task instanceof Fail) {
      fail(task.error);
    } else {
      throw Error('Task end up in an invalid state');
    }
  }
};

var step = function step(root, task, succeed, fail) {
  if (task instanceof Succeed) {
    return new Done(task);
  } else if (task instanceof Fail) {
    return new Done(task);
  } else if (task instanceof Deferred) {
    if (task.result != null) {
      return new Running(task.result);
    } else {
      throw new Error('Blocked routine should not be resumed until blocking task is complete');
    }
  } else if (task instanceof Chain || task instanceof Map || task instanceof Capture || task instanceof Format) {
    var routine = new Running(task.task);
    while (routine instanceof Running) {
      routine = step(root, routine.task, succeed, fail);
    }

    if (routine instanceof Done) {
      var active = routine.task;

      if (active instanceof Succeed) {
        if (task instanceof Chain) {
          return new Running(task.next(active.value));
        } else if (task instanceof Map) {
          return new Done(new Succeed(task.f(active.value)));
        } else {
          return routine;
        }
      } else if (active instanceof Fail) {
        if (task instanceof Capture) {
          return new Running(task.handle(active.error));
        } else if (task instanceof Format) {
          return new Done(new Fail(task.f(active.error)));
        } else {
          return routine;
        }
      } else {
        return routine;
      }
    } else if (routine instanceof Blocked) {
      if (task instanceof Chain) {
        return new Blocked(new Chain(routine.task, task.next));
      } else if (task instanceof Capture) {
        return new Blocked(new Capture(routine.task, task.handle));
      } else if (task instanceof Map) {
        return new Blocked(new Map(routine.task, task.f));
      } else if (task instanceof Format) {
        return new Blocked(new Format(routine.task, task.f));
      } else {
        return routine;
      }
    } else {
      return routine;
    }
  } else {
    var _ret = function () {
      var isBlocked = false;
      var isResumed = false;
      var deferred = new Deferred();

      task.fork(function (value) {
        if (!isResumed) {
          isResumed = true;
          deferred.resume(new Succeed(value));
          if (isBlocked) {
            run(root, succeed, fail);
          }
        }
      }, function (error) {
        if (!isResumed) {
          isResumed = true;
          deferred.resume(new Fail(error));
          if (isBlocked) {
            run(root, succeed, fail);
          }
        }
      });

      isBlocked = !isResumed;

      var routine = deferred.result != null ? new Running(deferred.result) : new Blocked(deferred);

      return {
        v: routine
      };
    }();

    if ((typeof _ret === 'undefined' ? 'undefined' : _typeof(_ret)) === "object") return _ret.v;
  }
};
//# sourceMappingURL=data:application/json;base64,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aUJBQVM7QUFDUCxZQUFJLENBQUMsU0FBRCxFQUFZO0FBQ2Qsc0JBQVksSUFBWixDQURjO0FBRWQsbUJBQVMsTUFBVCxDQUFnQixJQUFJLElBQUosQ0FBUyxLQUFULENBQWhCLEVBRmM7QUFHZCxjQUFJLFNBQUosRUFBZTtBQUNiLGdCQUFJLElBQUosRUFBVSxPQUFWLEVBQW1CLElBQW5CLEVBRGE7V0FBZjtTQUhGO09BREYsQ0FWRjs7QUFxQkEsa0JBQVksQ0FBQyxTQUFEOztBQUVaLFVBQU0sVUFDRixTQUFTLE1BQVQsSUFBbUIsSUFBbkIsR0FDQSxJQUFJLE9BQUosQ0FBWSxTQUFTLE1BQVQsQ0FEWixHQUVBLElBQUksT0FBSixDQUFZLFFBQVosQ0FGQTs7QUFLSjtXQUFPO09BQVA7UUFsQ0c7OztHQTlEQTtDQXBCUCIsImZpbGUiOiJ0YXNrLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogQGZsb3cgKi9cblxuLyo6OlxuaW1wb3J0IHR5cGUge1RpbWUsIFRocmVhZElEfSBmcm9tIFwiLi90YXNrXCJcbmltcG9ydCB0eXBlIHtBZGRyZXNzfSBmcm9tIFwiLi9zaWduYWxcIlxuXG5leHBvcnQgdHlwZSB7VGhyZWFkSUQsIFRpbWV9XG4qL1xuXG5leHBvcnQgY2xhc3MgVGFzayAvKjo6PHgsIGE+Ki8ge1xuICBzdGF0aWMgY3JlYXRlIC8qOjo8eCwgYT4qLyhleGVjdXRlLyo6KHN1Y2NlZWQ6KGE6YSkgPT4gdm9pZCwgZmFpbDooeDp4KSA9PiB2b2lkKSA9PiB2b2lkKi8pLyo6VGFzazx4LCBhPiovIHtcbiAgICByZXR1cm4gbmV3IFRhc2soZXhlY3V0ZSlcbiAgfVxuXG4gIHN0YXRpYyBmdXR1cmUgLyo6Ojx4LCBhPiovKHJlcXVlc3QvKjooKSA9PiBQcm9taXNlPGE+Ki8pLyo6VGFzazx4LCBhPiovIHtcbiAgICBjb25zb2xlLndhcm4oJ1Rhc2suZnV0dXJlIGlzIGRlcHJlY2F0ZWQgQVBJIHVzZSBUYXNrLmNyZWF0ZSBpbnN0ZWFkJylcbiAgICByZXR1cm4gbmV3IEZ1dHVyZShyZXF1ZXN0KVxuICB9XG5cbiAgc3RhdGljIHN1Y2NlZWQgLyo6Ojx4LCBhPiovKHZhbHVlLyo6YSovKS8qOlRhc2s8eCwgYT4qLyB7XG4gICAgcmV0dXJuIG5ldyBTdWNjZWVkKHZhbHVlKVxuICB9XG5cbiAgc3RhdGljIGZhaWwgLyo6Ojx4LCBhPiovIChlcnJvci8qOngqLykvKjpUYXNrPHgsIGE+Ki8ge1xuICAgIHJldHVybiBuZXcgRmFpbChlcnJvcilcbiAgfVxuXG4gIHN0YXRpYyBzcGF3biAvKjo6PHgsIHksIGE+Ki8gKHRhc2svKjpUYXNrPHgsIGE+Ki8pLyo6VGFzazx5LCBUaHJlYWRJRD4qLyB7XG4gICAgcmV0dXJuIG5ldyBTcGF3bih0YXNrKVxuICB9XG5cblxuICBzdGF0aWMgc2xlZXAgLyo6Ojx4PiovICh0aW1lOlRpbWUpLyo6VGFzazx4LCB2b2lkPiovIHtcbiAgICByZXR1cm4gbmV3IFNsZWVwKHRpbWUpXG4gIH1cblxuICBzdGF0aWMgc2VuZCAvKjo6PHgsIGE+Ki8gKGFkZHJlc3MvKjpBZGRyZXNzPGE+Ki8sIG1lc3NhZ2UvKjphKi8pLyo6VGFzazx4LCB2b2lkPiovIHtcbiAgICByZXR1cm4gbmV3IFNlbmQoYWRkcmVzcywgbWVzc2FnZSlcbiAgfVxuXG4gIHN0YXRpYyBmb3JrIC8qOjo8eCwgYT4qLyh0YXNrLyo6VGFzazx4LCBhPiovLCBvblN1Y2NlZWQvKjooYTphKSA9PiB2b2lkKi8sIG9uRmFpbC8qOih4OngpID0+IHZvaWQqLykvKjp2b2lkKi8ge1xuICAgIHJ1bihuZXcgUnVubmluZyh0YXNrKSwgb25TdWNjZWVkLCBvbkZhaWwpXG4gIH1cblxuICAvKjo6XG4gIGV4ZWN1dGU6IChzdWNjZWVkOihhOmEpID0+IHZvaWQsIGZhaWw6KHg6eCkgPT4gdm9pZCkgPT4gdm9pZDtcbiAgKi9cbiAgY29uc3RydWN0b3IoZXhlY3V0ZS8qOihzdWNjZWVkOihhOmEpID0+IHZvaWQsIGZhaWw6KHg6eCkgPT4gdm9pZCkgPT4gdm9pZCovKSB7XG4gICAgdGhpcy5leGVjdXRlID0gZXhlY3V0ZVxuICB9XG4gIGNoYWluIC8qOjo8Yj4qLyhuZXh0Lyo6KGE6YSkgPT4gVGFzazx4LGI+Ki8pLyo6VGFzazx4LCBiPiovIHtcbiAgICByZXR1cm4gbmV3IENoYWluKHRoaXMsIG5leHQpXG4gIH1cbiAgbWFwIC8qOjo8Yj4qLyhmLyo6KGlucHV0OmEpID0+IGIqLykvKjpUYXNrPHgsIGI+Ki8ge1xuICAgIHJldHVybiBuZXcgTWFwKHRoaXMsIGYpXG4gIH1cbiAgY2FwdHVyZSAvKjo6PHk+Ki8oaGFuZGxlLyo6KGVycm9yOngpID0+IFRhc2s8eSwgYT4qLykvKjpUYXNrPHksIGE+Ki8ge1xuICAgIHJldHVybiBuZXcgQ2FwdHVyZSh0aGlzLCBoYW5kbGUpXG4gIH1cbiAgZm9ybWF0IC8qOjo8eT4qLyAoZi8qOihpbnB1dDp4KSA9PiB5Ki8pLyo6VGFzazx5LCBhPiovIHtcbiAgICByZXR1cm4gbmV3IEZvcm1hdCh0aGlzLCBmKVxuICB9XG4gIGZvcmsoc3VjY2VlZC8qOihhOmEpID0+IHZvaWQqLywgZmFpbC8qOih4OngpID0+IHZvaWQqLykvKjp2b2lkKi8ge1xuICAgIHRoaXMuZXhlY3V0ZVxuICAgICggc3VjY2VlZFxuICAgICwgZmFpbFxuICAgIClcbiAgfVxufVxuXG5cblxuY2xhc3MgU3VjY2VlZCAvKjo6PHgsYT4qLyBleHRlbmRzIFRhc2sgLyo6Ojx4LCBhPiovIHtcbiAgLyo6OlxuICB2YWx1ZTogYTtcbiAgKi9cbiAgY29uc3RydWN0b3IodmFsdWUvKjphKi8pIHtcbiAgICBzdXBlcihTdWNjZWVkLnByb3RvdHlwZS5mb3JrKVxuICAgIHRoaXMudmFsdWUgPSB2YWx1ZVxuICB9XG4gIGZvcmsoc3VjY2VlZC8qOihhOmEpID0+IHZvaWQqLywgZmFpbC8qOih4OngpID0+IHZvaWQqLykvKjp2b2lkKi8ge1xuICAgIHN1Y2NlZWQodGhpcy52YWx1ZSlcbiAgfVxufVxuXG5jbGFzcyBGYWlsIC8qOjo8eCwgYT4qLyBleHRlbmRzIFRhc2sgLyo6Ojx4LCBhPiovIHtcbiAgLyo6OlxuICBlcnJvcjogeDtcbiAgKi9cbiAgY29uc3RydWN0b3IoZXJyb3IvKjp4Ki8pIHtcbiAgICBzdXBlcihGYWlsLnByb3RvdHlwZS5mb3JrKVxuICAgIHRoaXMuZXJyb3IgPSBlcnJvclxuICB9XG4gIGZvcmsoc3VjY2VlZC8qOihhOmEpID0+IHZvaWQqLywgZmFpbC8qOih4OngpID0+IHZvaWQqLykvKjp2b2lkKi8ge1xuICAgIGZhaWwodGhpcy5lcnJvcilcbiAgfVxufVxuXG5jbGFzcyBTbGVlcCAvKjo6PHgsIGE6dm9pZD4qLyBleHRlbmRzIFRhc2sgLyo6Ojx4LCB2b2lkPiovIHtcbiAgLyo6OlxuICB0aW1lOiBUaW1lO1xuICAqL1xuICBjb25zdHJ1Y3Rvcih0aW1lLyo6VGltZSovKSB7XG4gICAgc3VwZXIoU2xlZXAucHJvdG90eXBlLmZvcmspXG4gICAgdGhpcy50aW1lID0gdGltZVxuICB9XG4gIGZvcmsoc3VjY2VlZC8qOihhOmEpID0+IHZvaWQqLywgZmFpbC8qOih4OngpID0+IHZvaWQqLykvKjp2b2lkKi8ge1xuICAgIHNldFRpbWVvdXQoc3VjY2VlZCwgdGhpcy50aW1lLCB2b2lkKDApKVxuICB9XG59XG5cbmxldCB0aHJlYWRJRCA9IDBcbmNsYXNzIFNwYXduIC8qOjo8eCwgeSwgYT4qLyBleHRlbmRzIFRhc2sgLyo6Ojx5LCBUaHJlYWRJRD4qLyB7XG4gIC8qOjpcbiAgdGFzazogVGFzazx4LCBhPjtcbiAgKi9cbiAgY29uc3RydWN0b3IodGFzay8qOlRhc2s8eCwgYT4qLykge1xuICAgIHN1cGVyKFNwYXduLnByb3RvdHlwZS5mb3JrKVxuICAgIHRoaXMudGFzayA9IHRhc2tcbiAgfVxuICBmb3JrKHN1Y2NlZWQvKjooYTpUaHJlYWRJRCkgPT4gdm9pZCovLCBmYWlsLyo6KHg6eSkgPT4gdm9pZCovKS8qOnZvaWQqLyB7XG4gICAgUHJvbWlzZVxuICAgIC5yZXNvbHZlKG51bGwpXG4gICAgLnRoZW4oXyA9PiBUYXNrLmZvcmsodGhpcy50YXNrLCBub29wLCBub29wKSlcblxuICAgIHN1Y2NlZWQoKyt0aHJlYWRJRClcbiAgfVxufVxuXG5jbGFzcyBTZW5kIC8qOjo8eCwgYT4qLyBleHRlbmRzIFRhc2sgLyo6Ojx4LCB2b2lkPiovIHtcbiAgLyo6OlxuICBtZXNzYWdlOiBhO1xuICBhZGRyZXNzOiBBZGRyZXNzPGE+O1xuICAqL1xuICBjb25zdHJ1Y3RvcihhZGRyZXNzLyo6QWRkcmVzczxhPiovLCBtZXNzYWdlLyo6YSovKSB7XG4gICAgc3VwZXIoU2VuZC5wcm90b3R5cGUuZm9yaylcbiAgICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlXG4gICAgdGhpcy5hZGRyZXNzID0gYWRkcmVzc1xuICB9XG4gIGZvcmsoc3VjY2VlZC8qOihhOnZvaWQpID0+IHZvaWQqLywgZmFpbC8qOih4OngpID0+IHZvaWQqLykvKjp2b2lkKi8ge1xuICAgIHN1Y2NlZWQodm9pZCh0aGlzLmFkZHJlc3ModGhpcy5tZXNzYWdlKSkpXG4gIH1cbn1cblxuY2xhc3MgRnV0dXJlIC8qOjo8eCwgYT4qLyBleHRlbmRzIFRhc2svKjo6PHgsIGE+Ki8ge1xuICAvKjo6XG4gIHJlcXVlc3Q6ICgpID0+IFByb21pc2U8YT47XG4gICovXG4gIGNvbnN0cnVjdG9yKHJlcXVlc3QvKjooKSA9PiBQcm9taXNlPGE+Ki8pIHtcbiAgICBzdXBlcihGdXR1cmUucHJvdG90eXBlLmZvcmspXG4gICAgdGhpcy5yZXF1ZXN0ID0gcmVxdWVzdFxuICB9XG4gIGZvcmsoc3VjY2VlZC8qOihhOmEpID0+IHZvaWQqLywgZmFpbC8qOih4OngpID0+IHZvaWQqLykvKjp2b2lkKi8ge1xuICAgIHRoaXMucmVxdWVzdCgpLnRoZW4oc3VjY2VlZCwgZmFpbClcbiAgfVxufVxuXG5jbGFzcyBDaGFpbiAvKjo6PHgsIGEsIGI+Ki8gZXh0ZW5kcyBUYXNrLyo6Ojx4LCBhPiovIHtcbiAgLyo6OlxuICB0YXNrOiBUYXNrPHgsIGI+O1xuICBuZXh0OiAoaW5wdXQ6YikgPT4gVGFzazx4LCBhPjtcbiAgKi9cbiAgY29uc3RydWN0b3IodGFzay8qOlRhc2s8eCwgYj4qLywgbmV4dC8qOihpbnB1dDpiKSA9PiBUYXNrPHgsIGE+Ki8pIHtcbiAgICBzdXBlcihDaGFpbi5wcm90b3R5cGUuZm9yaylcbiAgICB0aGlzLnRhc2sgPSB0YXNrXG4gICAgdGhpcy5uZXh0ID0gbmV4dFxuICB9XG4gIGZvcmsoc3VjY2VlZC8qOih2YWx1ZTphKSA9PiB2b2lkKi8sIGZhaWwvKjooZXJyb3I6eCkgPT4gdm9pZCovKS8qOnZvaWQqLyB7XG4gICAgdGhpcy50YXNrLmZvcmtcbiAgICAoIHZhbHVlID0+IHRoaXMubmV4dCh2YWx1ZSkuZm9yayhzdWNjZWVkLCBmYWlsKVxuICAgICwgZmFpbFxuICAgIClcbiAgfVxufVxuXG5jbGFzcyBNYXAgLyo6Ojx4LCBhLCBiPiovIGV4dGVuZHMgVGFzay8qOjo8eCwgYj4qLyB7XG4gIC8qOjpcbiAgdGFzazogVGFzazx4LCBhPjtcbiAgZjogKGlucHV0OmEpID0+IGI7XG4gICovXG4gIGNvbnN0cnVjdG9yKHRhc2svKjpUYXNrPHgsIGE+Ki8sIGYvKjooaW5wdXQ6YSkgPT4gYiovKSB7XG4gICAgc3VwZXIoTWFwLnByb3RvdHlwZS5mb3JrKVxuICAgIHRoaXMudGFzayA9IHRhc2tcbiAgICB0aGlzLmYgPSBmXG4gIH1cbiAgZm9yayhzdWNjZWVkLyo6KHZhbHVlOmIpID0+IHZvaWQqLywgZmFpbC8qOihlcnJvcjp4KSA9PiB2b2lkKi8pLyo6dm9pZCovIHtcbiAgICB0aGlzLnRhc2suZm9ya1xuICAgICggdmFsdWUgPT4gc3VjY2VlZCh0aGlzLmYodmFsdWUpKVxuICAgICwgZmFpbFxuICAgIClcbiAgfVxufVxuXG5jbGFzcyBDYXB0dXJlLyo6Ojx4LCB5LCBhPiovZXh0ZW5kcyBUYXNrLyo6Ojx5LCBhPiove1xuICAvKjo6XG4gIHRhc2s6IFRhc2s8eCwgYT47XG4gIGhhbmRsZTogKGVycm9yOngpID0+IFRhc2s8eSwgYT47XG4gICovXG4gIGNvbnN0cnVjdG9yKHRhc2svKjpUYXNrPHgsIGE+Ki8sIGhhbmRsZS8qOihlcnJvcjp4KSA9PiBUYXNrPHksIGE+Ki8pIHtcbiAgICBzdXBlcihDYXB0dXJlLnByb3RvdHlwZS5mb3JrKVxuICAgIHRoaXMudGFzayA9IHRhc2tcbiAgICB0aGlzLmhhbmRsZSA9IGhhbmRsZVxuICB9XG4gIGZvcmsoc3VjY2VlZC8qOih2YWx1ZTphKSA9PiB2b2lkKi8sIGZhaWwvKjooZXJyb3I6eSkgPT4gdm9pZCovKS8qOnZvaWQqLyB7XG4gICAgdGhpcy50YXNrLmZvcmtcbiAgICAoIHN1Y2NlZWRcbiAgICAsIGVycm9yID0+IHRoaXMuaGFuZGxlKGVycm9yKS5mb3JrKHN1Y2NlZWQsIGZhaWwpXG4gICAgKVxuICB9XG59XG5cbmNsYXNzIEZvcm1hdC8qOjo8eCwgeSwgYT4qL2V4dGVuZHMgVGFzay8qOjo8eSwgYT4qL3tcbiAgLyo6OlxuICB0YXNrOiBUYXNrPHgsIGE+O1xuICBmOiAoaW5wdXQ6eCkgPT4geTtcbiAgKi9cbiAgY29uc3RydWN0b3IodGFzay8qOlRhc2s8eCwgYT4qLywgZi8qOihpbnB1dDp4KSA9PiB5Ki8pIHtcbiAgICBzdXBlcihGb3JtYXQucHJvdG90eXBlLmZvcmspXG4gICAgdGhpcy50YXNrID0gdGFza1xuICAgIHRoaXMuZiA9IGZcbiAgfVxuICBmb3JrKHN1Y2NlZWQvKjoodmFsdWU6YSkgPT4gdm9pZCovLCBmYWlsLyo6KGVycm9yOnkpID0+IHZvaWQqLykvKjp2b2lkKi8ge1xuICAgIHRoaXMudGFzay5mb3JrXG4gICAgKCBzdWNjZWVkXG4gICAgLCBlcnJvciA9PiBmYWlsKHRoaXMuZihlcnJvcikpXG4gICAgKVxuICB9XG59XG5cbmNsYXNzIERlZmVycmVkIC8qOjo8eCwgYT4qLyBleHRlbmRzIFRhc2sgLyo6Ojx4LCBhPiovIHtcbiAgLyo6OlxuICByZXN1bHQ6ID9UYXNrPHgsIGE+O1xuICAqL1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcihEZWZlcnJlZC5wcm90b3R5cGUuZm9yaylcbiAgfVxuICByZXN1bWUodGFzay8qOlRhc2s8eCwgYT4qLykvKjp2b2lkKi8ge1xuICAgIGlmICh0aGlzLnJlc3VsdCAhPSBudWxsKSB7XG4gICAgICB0aHJvdyBFcnJvcignRGVmZXJyZWQgdGFzayBjYW4gb25seSBiZSByZXN1bWVkIG9uY2UnKVxuICAgIH1cbiAgICB0aGlzLnJlc3VsdCA9IHRhc2tcbiAgfVxuICBmb3JrKHN1Y2NlZWQvKjooYTphKSA9PiB2b2lkKi8sIGZhaWwvKjooeDp4KSA9PiB2b2lkKi8pLyo6dm9pZCovIHtcbiAgICB0aHJvdyBFcnJvcignRm9ya2luZyBkZWZmZXJyZWQgdGFzayBpcyBub3QgYWxsb3dlZCcpXG4gIH1cbn1cblxuY29uc3Qgbm9vcCA9ICgpID0+IHZvaWQoMClcblxuY2xhc3MgUnVubmluZyAvKjo6PHgsIGE+Ki8ge1xuICAvKjo6XG4gIHRhc2s6IFRhc2s8eCwgYT47XG4gICovXG4gIGNvbnN0cnVjdG9yIC8qOjo8eCwgYT4qLyh0YXNrLyo6VGFzazx4LCBhPiovKSB7XG4gICAgdGhpcy50YXNrID0gdGFza1xuICB9XG59XG5cbmNsYXNzIERvbmUgLyo6Ojx4LCBhPiovIHtcbiAgLyo6OlxuICB0YXNrOiBUYXNrPHgsIGE+O1xuICAqL1xuICBjb25zdHJ1Y3Rvcih0YXNrLyo6U3VjY2VlZDx4LCBhPiB8IEZhaWw8eCwgYT4qLykge1xuICAgIHRoaXMudGFzayA9IHRhc2tcbiAgfVxufVxuXG5jbGFzcyBCbG9ja2VkIC8qOjo8eCwgYT4qLyB7XG4gIC8qOjpcbiAgdGFzazogVGFzazx4LCBhPjtcbiAgKi9cbiAgY29uc3RydWN0b3IodGFzay8qOlRhc2s8eCwgYT4qLykge1xuICAgIHRoaXMudGFzayA9IHRhc2tcbiAgfVxufVxuXG4vKjo6XG50eXBlIFJvdXRpbmUgPHgsIGE+XG4gID0gQmxvY2tlZCA8eCwgYT5cbiAgfCBEb25lIDx4LCBhPlxuICB8IFJ1bm5pbmcgPHgsIGE+XG4qL1xuXG5jb25zdCBydW4gPSAvKjo6PHgsIGE+Ki9cbiAgKCByb290Lyo6Um91dGluZTx4LCBhPiovXG4gICwgc3VjY2VlZC8qOih2YWx1ZTphKSA9PiB2b2lkKi9cbiAgLCBmYWlsLyo6KGVycm9yOngpID0+IHZvaWQqL1xuICApLyo6dm9pZCovID0+XG4gIHtcbiAgICBsZXQgcm91dGluZSA9IG5ldyBSdW5uaW5nKHJvb3QudGFzaylcbiAgICB3aGlsZSAocm91dGluZSBpbnN0YW5jZW9mIFJ1bm5pbmcpIHtcbiAgICAgIHJvdXRpbmUgPSBzdGVwKHJvb3QsIHJvdXRpbmUudGFzaywgc3VjY2VlZCwgZmFpbClcbiAgICB9XG5cbiAgICBpZiAocm91dGluZSBpbnN0YW5jZW9mIEJsb2NrZWQpIHtcbiAgICAgIHJvb3QudGFzayA9IHJvdXRpbmUudGFza1xuICAgIH1cblxuICAgIGlmIChyb3V0aW5lIGluc3RhbmNlb2YgRG9uZSkge1xuICAgICAgY29uc3QgdGFzayA9IHJvdXRpbmUudGFza1xuICAgICAgaWYgKHRhc2sgaW5zdGFuY2VvZiBTdWNjZWVkKSB7XG4gICAgICAgIHN1Y2NlZWQodGFzay52YWx1ZSlcbiAgICAgIH1cbiAgICAgIGVsc2UgaWYgKHRhc2sgaW5zdGFuY2VvZiBGYWlsKSB7XG4gICAgICAgIGZhaWwodGFzay5lcnJvcilcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICB0aHJvdyBFcnJvcignVGFzayBlbmQgdXAgaW4gYW4gaW52YWxpZCBzdGF0ZScpXG4gICAgICB9XG4gICAgfVxuICB9XG5cbmNvbnN0IHN0ZXAgPSAvKjo6PHgsIHksIGEsIGI+Ki9cbiAgKCByb290Lyo6Um91dGluZSovXG4gICwgdGFzay8qOlRhc2s8eCwgYT4qL1xuICAsIHN1Y2NlZWQvKjoodmFsdWU6YikgPT4gdm9pZCovXG4gICwgZmFpbC8qOihlcnJvcjp5KSA9PiB2b2lkKi9cbiAgKS8qOlJvdXRpbmUqLyA9PlxuICB7XG4gICAgaWYgKHRhc2sgaW5zdGFuY2VvZiBTdWNjZWVkKSB7XG4gICAgICByZXR1cm4gbmV3IERvbmUodGFzaylcbiAgICB9XG4gICAgZWxzZSBpZiAodGFzayBpbnN0YW5jZW9mIEZhaWwpIHtcbiAgICAgIHJldHVybiBuZXcgRG9uZSh0YXNrKVxuICAgIH1cbiAgICBlbHNlIGlmICh0YXNrIGluc3RhbmNlb2YgRGVmZXJyZWQpIHtcbiAgICAgIGlmICh0YXNrLnJlc3VsdCAhPSBudWxsKSB7XG4gICAgICAgIHJldHVybiBuZXcgUnVubmluZyh0YXNrLnJlc3VsdClcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Jsb2NrZWQgcm91dGluZSBzaG91bGQgbm90IGJlIHJlc3VtZWQgdW50aWwgYmxvY2tpbmcgdGFzayBpcyBjb21wbGV0ZScpXG4gICAgICB9XG4gICAgfVxuICAgIGVsc2UgaWYgKFxuICAgICAgdGFzayBpbnN0YW5jZW9mIENoYWluIHx8XG4gICAgICB0YXNrIGluc3RhbmNlb2YgTWFwIHx8XG4gICAgICB0YXNrIGluc3RhbmNlb2YgQ2FwdHVyZSB8fFxuICAgICAgdGFzayBpbnN0YW5jZW9mIEZvcm1hdFxuICAgIClcbiAgICB7XG4gICAgICBsZXQgcm91dGluZSA9IG5ldyBSdW5uaW5nKHRhc2sudGFzaylcbiAgICAgIHdoaWxlIChyb3V0aW5lIGluc3RhbmNlb2YgUnVubmluZykge1xuICAgICAgICByb3V0aW5lID0gc3RlcChyb290LCByb3V0aW5lLnRhc2ssIHN1Y2NlZWQsIGZhaWwpXG4gICAgICB9XG5cbiAgICAgIGlmIChyb3V0aW5lIGluc3RhbmNlb2YgRG9uZSkge1xuICAgICAgICBjb25zdCBhY3RpdmUgPSByb3V0aW5lLnRhc2tcblxuICAgICAgICBpZiAoYWN0aXZlIGluc3RhbmNlb2YgU3VjY2VlZCkge1xuICAgICAgICAgIGlmICh0YXNrIGluc3RhbmNlb2YgQ2hhaW4pIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgUnVubmluZyh0YXNrLm5leHQoYWN0aXZlLnZhbHVlKSlcbiAgICAgICAgICB9XG4gICAgICAgICAgZWxzZSBpZiAodGFzayBpbnN0YW5jZW9mIE1hcCkge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBEb25lKG5ldyBTdWNjZWVkKHRhc2suZihhY3RpdmUudmFsdWUpKSlcbiAgICAgICAgICB9XG4gICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gcm91dGluZVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChhY3RpdmUgaW5zdGFuY2VvZiBGYWlsKSB7XG4gICAgICAgICAgaWYgKHRhc2sgaW5zdGFuY2VvZiBDYXB0dXJlKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFJ1bm5pbmcodGFzay5oYW5kbGUoYWN0aXZlLmVycm9yKSlcbiAgICAgICAgICB9XG4gICAgICAgICAgZWxzZSBpZiAodGFzayBpbnN0YW5jZW9mIEZvcm1hdCkge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBEb25lKG5ldyBGYWlsKHRhc2suZihhY3RpdmUuZXJyb3IpKSlcbiAgICAgICAgICB9XG4gICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gcm91dGluZVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gcm91dGluZVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBlbHNlIGlmIChyb3V0aW5lIGluc3RhbmNlb2YgQmxvY2tlZCkge1xuICAgICAgICBpZiAodGFzayBpbnN0YW5jZW9mIENoYWluKSB7XG4gICAgICAgICAgcmV0dXJuIG5ldyBCbG9ja2VkKG5ldyBDaGFpbihyb3V0aW5lLnRhc2ssIHRhc2submV4dCkpXG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAodGFzayBpbnN0YW5jZW9mIENhcHR1cmUpIHtcbiAgICAgICAgICByZXR1cm4gbmV3IEJsb2NrZWQobmV3IENhcHR1cmUocm91dGluZS50YXNrLCB0YXNrLmhhbmRsZSkpXG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAodGFzayBpbnN0YW5jZW9mIE1hcCkge1xuICAgICAgICAgIHJldHVybiBuZXcgQmxvY2tlZChuZXcgTWFwKHJvdXRpbmUudGFzaywgdGFzay5mKSlcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmICh0YXNrIGluc3RhbmNlb2YgRm9ybWF0KSB7XG4gICAgICAgICAgcmV0dXJuIG5ldyBCbG9ja2VkKG5ldyBGb3JtYXQocm91dGluZS50YXNrLCB0YXNrLmYpKVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgIHJldHVybiByb3V0aW5lXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICByZXR1cm4gcm91dGluZVxuICAgICAgfVxuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIGxldCBpc0Jsb2NrZWQgPSBmYWxzZVxuICAgICAgbGV0IGlzUmVzdW1lZCA9IGZhbHNlXG4gICAgICBjb25zdCBkZWZlcnJlZCA9IG5ldyBEZWZlcnJlZCgpXG5cbiAgICAgIHRhc2suZm9ya1xuICAgICAgKCB2YWx1ZSA9PiB7XG4gICAgICAgICAgaWYgKCFpc1Jlc3VtZWQpIHtcbiAgICAgICAgICAgIGlzUmVzdW1lZCA9IHRydWVcbiAgICAgICAgICAgIGRlZmVycmVkLnJlc3VtZShuZXcgU3VjY2VlZCh2YWx1ZSkpXG4gICAgICAgICAgICBpZiAoaXNCbG9ja2VkKSB7XG4gICAgICAgICAgICAgIHJ1bihyb290LCBzdWNjZWVkLCBmYWlsKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgLCBlcnJvciA9PiB7XG4gICAgICAgICAgaWYgKCFpc1Jlc3VtZWQpIHtcbiAgICAgICAgICAgIGlzUmVzdW1lZCA9IHRydWVcbiAgICAgICAgICAgIGRlZmVycmVkLnJlc3VtZShuZXcgRmFpbChlcnJvcikpXG4gICAgICAgICAgICBpZiAoaXNCbG9ja2VkKSB7XG4gICAgICAgICAgICAgIHJ1bihyb290LCBzdWNjZWVkLCBmYWlsKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKVxuXG4gICAgICBpc0Jsb2NrZWQgPSAhaXNSZXN1bWVkXG5cbiAgICAgIGNvbnN0IHJvdXRpbmUgPVxuICAgICAgICAoIGRlZmVycmVkLnJlc3VsdCAhPSBudWxsXG4gICAgICAgID8gbmV3IFJ1bm5pbmcoZGVmZXJyZWQucmVzdWx0KVxuICAgICAgICA6IG5ldyBCbG9ja2VkKGRlZmVycmVkKVxuICAgICAgICApXG5cbiAgICAgIHJldHVybiByb3V0aW5lXG4gICAgfVxuICB9XG4iXX0=